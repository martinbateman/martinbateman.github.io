<HTML>
<head>
  <title>CO3509 Lab 1 - Example</title>
  <link rel="stylesheet" type="text/css" href="https://martinbateman.github.io/style.css"/>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script id="odauth" src="https://martinbateman.github.io/odauth.js"></script>
  
  <link rel="icon" href="https://d.sfx-df.ms/images/favicon.ico" type="image/x-icon">
  <link rel="mask-icon" href="https://d.sfx-df.ms/images/mask_icon.svg" color="#094AB2">

  <style>
    li.tick{
      text-decoration: line-through;
    }
    li.tick:after{
      content: "\2713";
      color: darkgreen;
    }
    li.missed{
      text-decoration: underline;
    }
    li.missed:after{
      content: "<--";
      color: red;
    }
  </style>
<script>
    function signInToOneDrive()
    {
      var appInfo = {
        "clientId": "da55778d-4c93-4a5d-9ac9-7e3d95c531ef",
        "redirectUri": "https://martinbateman.github.io/callback.html",
        "scopes": "files.readwrite.all",
        "authServiceUri": "https://login.microsoftonline.com/common/oauth2/v2.0/authorize"
      };
      provideAppInfo(appInfo);

      var baseUrl = getQueryVariable("baseUrl")
      msGraphApiRoot = (baseUrl) ? baseUrl : "https://graph.microsoft.com/v1.0/me";

      challengeForAuth();

      saveToCookie( { "apiRoot": msGraphApiRoot, "signedin": true } );
      return false;
    }

    function showCustomLoginButton(show)
    {
      var loginButton = document.getElementById("od-login");
      loginButton.style.display = show ? "block" : "none";

      var logoutButton = document.getElementById("od-logoff");
      logoutButton.style.display = show ? "none" : "block";
    }
    function saveToCookie(obj)
    {
      var expiration = new Date();
      expiration.setTime(expiration.getTime() + 3600 * 1000);
      var data = JSON.stringify(obj);
      var cookie = "odexplorer=" + data +"; path=/; expires=" + expiration.toUTCString();

      if (document.location.protocol.toLowerCase() == "https") {
        cookie = cookie + ";secure";
      }
      document.cookie = cookie;
    }
    function loadFromCookie()
    {
      var cookies = document.cookie;
      var name = "odexplorer=";
      var start = cookies.indexOf(name);
      if (start >= 0) {
        start += name.length;
        var end = cookies.indexOf(';', start);
        if (end < 0) {
          end = cookies.length;
        }
        else {
          postCookie = cookies.substring(end);
        }

        var value = cookies.substring(start, end);
        return JSON.parse(value);
      }
    return "";
    }
    function signOut()
    {
      logoutOfAuth();
      saveToCookie( { "apiRoot": msGraphApiRoot, "signedin": false } );
      $('#od-breadcrumb').empty();
      $('#od-items').empty();
      $('#od-json').empty();
      location.reload();
      clearInterval ();
    }
    function getQueryVariable(variable)
    {
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
     }

  var globalToken = "";
  var moduleCode = "CO3509";
  var assignmentNumber = "1";
  var saved = 1;
  var itemID = "";
  var maxX = 0;
  var maxX = 0;
  var settingDir = "appData";
  var fileName = "/" + settingDir + "/" + moduleCode + "-lab-" + assignmentNumber + ".json"; 
  var pageTitle = "CO3509 Lab 1 - Example";
  </script>
</head>
<BODY>
 <div id="od-site">
    <div id="od-commands">
      <div id="od-login" style="display: hidden">
        <a href="#" onclick="signInToOneDrive()">Sign in to OneDrive</a>&nbsp;&nbsp;
      </div>
      <div id="od-logoff" style="display: hidden">
        <a href="#" onclick="signOut()">Sign Out</a>
      </div>
    </div>
    <div id="od-title">CO3509 Lab 1 - Example</div>
  </div>

  <div id="od-loading"></div>
  <div id="od-content">
<p>
This lab introduces the use of Windows Server. You are going to install your first copy of Windows Server 2016
You will need a Windows Server 2016 R2 ISO and a product key. The ISO should be on the d: drive of the lab computer and
you can use a KMS key from <a href="https://technet.microsoft.com/en-gb/library/jj612867.aspx">https://technet.microsoft.com/en-gb/library/jj612867.aspx</a>
You can download the ISOs used in this module, as well as VMware Workstation from onethehub.com. Details are on Blackboard in the useful links section.

If you have never used VMware before then I suggest you watch 
<a href="https://www.lynda.com/Fusion-tutorials/Installing-VMware-Workstation/163066/175191-4.html?org=uclan.ac.uk">this</a>. You do not need to install VMware 
Workstation 
in the lab as it is already installed.

</p>
<ol id="instructions">
  <li>Start VMware workstation and click 'Create a New Virtual Machine'. Select 'Typical (recommended)' and click next.</li>
  <li>Select 'I will install the operating system later.' and click Next.</li>
  <li>For the guest operating systems select Microsoft Windows and for the version select 'Windows Server 2016' and click next.</li>
  <li>For the machine name use 'Windows Server 2016', change the location to the e: drive. You should create a folder on the e: drive to store the virtual machines. Use your username as the folder name.</li>
  <li>Leave the disk capacity as 60 GB and leave the disk as 'Split virtual disk into multiple files'. Click Next.</li>
  <li>Click 'customize Hardware'. Change the Memory to 4 GB and change the number of processors to 2. Change the Network Adapter to Host-only, finally 
change the CD/DVD to Use ISO image file. Select the Windows Server 2016 ISO from the d: drive. Click 'Close'.</li>
  <li>Click 'Finish'.</li>
  <li>Click 'Power on this Virtual Machine'.</li>
<h2>Installing Windows Server 2016</h2>
  <li>Insert the ISO into the virtual CDROM and power on the virtual machine.</li>
  <li>Click Install now</li>
  <li>Enter your product key, You can either use a product key from OnTheHub or you can use a KMS Key from Microsoft see <a href="https://technet.microsoft.com/en-us/library/jj612867.aspx">here</a>.</li>
  <li>Select Windows Server 2016 (Desktop Experience)</li>
  <li>Accept the License and click next</li>
  <li>Select Custom: Install Windows only (advance)</li>
  <li>Click Next</li>
  <li>Wait while it install Windows. This could take a while.</li>
</ol>
<BR/>
<script>

lis = document.getElementById ('instructions').getElementsByTagName ('li');
for (i = 0; i < lis.length; i ++){
  lis[i].setAttribute ("id", i);
  lis[i].setAttribute ("onclick", "javascript:clicked("+i+")");
}

function clicked (cellID){
  if (globalToken != ""){
    saved = 0;
    document.getElementById("od-title").innerHTML = pageTitle + " (not saved)";
  }

  // set/remove colour background
  var parent = document.getElementById (cellID);
  if (parent.getAttribute ("class") == "tick") {
    parent.removeAttribute ("class");
    for (i = cellID-1; i >= 0; i --){
      li = document.getElementById (i);
      if (li.getAttribute ("class") == "tick") {
        break;
      } else {
        li.removeAttribute ("class");
      }
    }
     
  } else {
    parent.setAttribute ("class", "tick");
    for (i = cellID-1; i >= 0; i --){
      li = document.getElementById (i);
      if (li.getAttribute ("class") != "tick") {
        li.setAttribute ("class", "missed");
      }
    }



  }


//total;
}

</script>
  </div>
  <script>
    var baseUrl = getQueryVariable("baseUrl")
    msGraphApiRoot = (baseUrl) ? baseUrl : "https://graph.microsoft.com/v1.0/me";

    var data = loadFromCookie();
    if (data)
    {
      if (!baseUrl)
        msGraphApiRoot = data.apiRoot;
      showCustomLoginButton(!data.signedin)
    }

    $(document).on({
      ajaxStart: function() {$('body').addClass('loading');},
      ajaxStop:  function() {$('body').removeClass('loading');}
    });

    function uploadItem (){
          var contentURL = msGraphApiRoot + "/drive/items/" + itemID + "/content";

          lis = document.getElementById ('instructions').getElementsByTagName ('li');
          var labData = Array (lis.length);
          for (i = 0; i < lis.length; i ++){
            if (lis[i].getAttribute ("class") == "tick") {
              labData[i] = 1;
            } else {
              labData[i] = 0;
            }
          }

          $.ajax({
            url: contentURL,
            dataType: 'json',
            type: 'put',
            headers: { "Authorization": "Bearer " + globalToken },
            data: JSON.stringify (labData),
            success: function(data) {
              if (data) {
              }
            }
          });
    return (false);
    }

    function downloadItem (){
          var createAddDir = msGraphApiRoot + "/drive/root/children";
          var appDataID = "";

          var createFolder = { 
            "name": settingDir,
            "folder": { },
            "@microsoft.graph.conflictBehavior": "fail" // if it doesn't work it exists so don't worry (famous last words)
          };

          $.ajax({
            url: createAddDir,
            dataType: 'json',
            contentType: 'application/json',
            type: 'post',
            async: false,
            headers: { "Authorization": "Bearer " + globalToken },
            accept: "application/json;odata.metadata=none",
            data: JSON.stringify (createFolder)
          });


          var contentURL = msGraphApiRoot + "/drive/root:" + fileName; 
          $.ajax({
            url: contentURL,
            dataType: 'json',
            headers: { "Authorization": "Bearer " + globalToken },
            accept: "application/json;odata.metadata=none",
            success: function(data) {
              if (data) {
                itemID = data['id'];
                $('#od-value').val (data['@microsoft.graph.downloadUrl']);
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                  var labData = JSON.parse (xhttp.responseText);
                  lis = document.getElementById ('instructions').getElementsByTagName ('li');
                  for (var i = 0; i < lis.length; i ++){
                    var isChecked = labData[i];
                    if (isChecked == 1){
                      clicked (i);
                    }
                  }
                document.getElementById("od-title").innerHTML = pageTitle;
                saved = 1;
                }
                };
                xhttp.open("GET", data['@microsoft.graph.downloadUrl'], true);
                xhttp.send();
              }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
              // creating the setting file since it doesn't exist
            var contentURL = msGraphApiRoot + "/drive/root:" + fileName + ":/content";
            $.ajax({
              url: contentURL,
              dataType: 'json',
              contentType: 'text/plain',
              type: 'put',
              async: false,
              data: "[]",
              headers: { "Authorization": "Bearer " + globalToken },
              accept: "application/json;odata.metadata=none",
              success: function (data){
                if (data){
                  itemID = data['id'];
                }
              }
            });
              uploadItem ();
            }
          });
    return (false);
    }

   function onAuthenticated(token, authWindow) {
      globalToken = token;
      if (token) {
        if (authWindow) {
          removeLoginButton();
          authWindow.close();
        }
        downloadItem ();
        window.setInterval(function(){ // check if we need to save the page every 5 seconds if we are logged in.
          if (saved == 0){
            uploadItem ();
            document.getElementById("od-title").innerHTML = pageTitle;
            saved = 1;
          }
        }, 5000);
      }
      else {
        alert("Error signing in");
      }
    }

    odauth();
  </script>

</BODY>
</HTML>
